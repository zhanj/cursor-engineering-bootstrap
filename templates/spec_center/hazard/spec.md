# hazard｜隐患管理（spec）

## 1) Why（为什么做）
- 统一隐患全生命周期管理（登记、整改、复查、闭环）。
- 降低遗漏整改与超期风险，提升监管可追溯性。
- 为统计分析与风险预警提供标准化数据基础。

## 2) What（做什么）

### 2.1 能力范围（In Scope）
- 隐患列表查询（分页、筛选、排序）。
- 隐患详情查看与状态流转（待整改 -> 整改中 -> 待复查 -> 已闭环）。
- 整改记录与复查记录管理。
- 基础导出能力（按筛选条件导出）。

### 2.2 非范围（Out of Scope）
- 第三方工单系统双向同步（后续迭代）。
- 高级 BI 可视化看板（后续迭代）。
- 跨租户协同处置（后续迭代）。

## 3) 用户与场景（Who / Scenarios）
- 安全管理员：查看全量隐患并分派整改。
- 责任人：处理整改并提交整改结果。
- 复查人员：执行复查并判定是否闭环。

关键场景：
- 新增隐患后 24 小时内完成分派。
- 超期未整改隐患可被快速筛出。
- 复查不通过时自动回退到整改中。

## 4) 业务规则（Rules）
- 隐患状态必须按定义流转，不允许跳跃闭环。
- 整改前后需保留操作人、时间、备注审计信息。
- 复查不通过必须填写原因，且生成新的整改待办。

## 5) API / Contract 影响
- 影响契约文件：`hazard/contracts/openapi.yaml`
- 典型 endpoint（示例）：
  - `GET /api/hazards`
  - `GET /api/hazards/{id}`
  - `POST /api/hazards/{id}/rectify`
  - `POST /api/hazards/{id}/review`
- 兼容策略：
  - 新增字段尽量向后兼容（可选字段优先）。
  - 参数/返回结构变更需在 PR 中明确影响调用方。

## 6) 数据与迁移影响（可选）
- 是否涉及 DB 结构变更：否（示例）
- 若涉及：
  - 记录迁移脚本位置（Flyway/Liquibase）
  - 记录回滚策略与数据修复方案

## 7) DoD（完成定义）
- [ ] spec 与 `openapi.yaml` 已同步
- [ ] capability-registry 已更新能力条目与同义词
- [ ] 最小回归场景通过（成功/异常至少各 1 条）
- [ ] PR 已填写风险与回滚方案

## 8) 风险与回滚
- 主要风险：状态流转规则不一致导致闭环错误。
- 监控点：隐患超期数、复查驳回率、接口失败率。
- 回滚策略：按发布版本回退；必要时禁用新流转入口。

## 9) 外部依赖（若有）
- 第三方依赖契约放在 `_raw_contracts/external/<vendor>/openapi.yaml`。
- 本 spec 仅描述自有服务能力与第三方调用边界，不以第三方为主体。
