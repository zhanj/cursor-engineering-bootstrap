#!/usr/bin/env bash
set -euo pipefail

ROOT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")/.." && pwd)"
TEMPLATE_CONFIG="${ROOT_DIR}/templates/backend/.cursor/hooks/gates/config.sh"

usage() {
  echo "Usage:"
  echo "  bash bin/cursor-tune --target-dir <path> [options]"
  echo "  bash bin/cursor-tune --use-current-dir [options]"
  echo
  echo "Options:"
  echo "  --target-dir <path>   Target project root (required unless --use-current-dir)"
  echo "  --use-current-dir     Use current directory as target project root"
  echo "  --mode <mode>         safe|aggressive (default: aggressive)"
  echo "  --dry-run             Preview only (write report + diff, no file changes)"
}

TARGET_DIR=""
USE_CURRENT_DIR=0
TUNE_MODE="aggressive"
DRY_RUN=0

while [[ $# -gt 0 ]]; do
  case "$1" in
    --target-dir)
      TARGET_DIR="${2:-}"
      shift 2
      ;;
    --use-current-dir)
      USE_CURRENT_DIR=1
      shift
      ;;
    --mode)
      TUNE_MODE="${2:-}"
      shift 2
      ;;
    --dry-run)
      DRY_RUN=1
      shift
      ;;
    -h|--help)
      usage
      exit 0
      ;;
    *)
      echo "Unknown option: $1"
      usage
      exit 1
      ;;
  esac
done

if [[ -n "${TARGET_DIR}" && "${USE_CURRENT_DIR}" == "1" ]]; then
  echo "Use either --target-dir or --use-current-dir, not both."
  exit 1
fi
if [[ -z "${TARGET_DIR}" && "${USE_CURRENT_DIR}" != "1" ]]; then
  echo "Missing target directory. Use --target-dir <path> or --use-current-dir."
  exit 1
fi
if [[ "${USE_CURRENT_DIR}" == "1" ]]; then
  TARGET_DIR="."
fi
if [[ ! -d "${TARGET_DIR}" ]]; then
  echo "Target directory does not exist: ${TARGET_DIR}"
  exit 1
fi
if [[ "${TUNE_MODE}" != "safe" && "${TUNE_MODE}" != "aggressive" ]]; then
  echo "Invalid --mode: ${TUNE_MODE}. Expected safe|aggressive."
  exit 1
fi
if [[ ! -f "${TEMPLATE_CONFIG}" ]]; then
  echo "Missing template config: ${TEMPLATE_CONFIG}"
  exit 1
fi

PROJECT_DIR="$(cd "${TARGET_DIR}" && pwd)"
OUT_DIR="${PROJECT_DIR}/_cursor_init"
mkdir -p "${OUT_DIR}"
REPORT_FILE="${OUT_DIR}/tune-report.md"
DIFF_FILE="${OUT_DIR}/tune.diff"
INVENTORY_FILE="${OUT_DIR}/project-inventory.md"

declare -a CHANGED_FILES=()
declare -a ACTION_LOG=()
declare -a SUGGEST_LOG=()
declare -a MODULE_DIRS=()
declare -a API_FILES=()
declare -a SQL_FILES=()
declare -a SETTINGS_FILES=()
declare -a OPENAPI_FILES=()
declare -a SPEC_FILES=()
declare -a SERVICE_NAMES=()
declare -a BAD_SERVICE_DIR_HINTS=()
declare -a FRONTEND_API_FILES=()
declare -a FRONTEND_ROUTE_FILES=()

SERVICE_SLUG="service"
SCAN_STACK="unknown"
BACKEND_API_COUNT=0
FRONTEND_API_COUNT=0

add_unique_file() {
  local rel="$1"
  local f
  for f in "${CHANGED_FILES[@]+"${CHANGED_FILES[@]}"}"; do
    if [[ "${f}" == "${rel}" ]]; then
      return 0
    fi
  done
  CHANGED_FILES+=("${rel}")
}

append_action() {
  ACTION_LOG+=("$1")
}

append_suggest() {
  SUGGEST_LOG+=("$1")
}

contains_in_array() {
  local needle="$1"
  shift
  local item
  for item in "$@"; do
    if [[ "${item}" == "${needle}" ]]; then
      return 0
    fi
  done
  return 1
}

normalize_slug() {
  local raw="$1"
  local out
  out="$(printf "%s" "${raw}" | tr '[:upper:]' '[:lower:]' | tr -c 'a-z0-9._-' '-')"
  out="$(printf "%s" "${out}" | sed -E 's/^-+//; s/-+$//; s/-{2,}/-/g')"
  printf "%s" "${out}"
}

SETTINGS_FILE=""
MULTI_MODULE=0
HAS_DOC_SQL=0

scan_project() {
  local sf pom rel rel_dir api sql openapi rel_openapi spec rel_spec service_raw service_name raw_service routef

  shopt -s nullglob
  for sf in "${PROJECT_DIR}"/settings-*.xml; do
    if [[ -f "${sf}" ]]; then
      SETTINGS_FILES+=("$(basename "${sf}")")
    fi
  done
  shopt -u nullglob
  if [[ ${#SETTINGS_FILES[@]} -gt 0 ]]; then
    SETTINGS_FILE="${SETTINGS_FILES[0]}"
  fi

  while IFS= read -r pom; do
    rel="${pom#${PROJECT_DIR}/}"
    rel_dir="$(dirname "${rel}")"
    if [[ "${rel_dir}" == "." ]]; then
      rel_dir="root"
    fi
    if ! contains_in_array "${rel_dir}" "${MODULE_DIRS[@]+"${MODULE_DIRS[@]}"}"; then
      MODULE_DIRS+=("${rel_dir}")
    fi
  done < <(find "${PROJECT_DIR}" -type f -name pom.xml -not -path "*/target/*" 2>/dev/null)
  if [[ ${#MODULE_DIRS[@]} -gt 1 ]]; then
    MULTI_MODULE=1
  fi

  while IFS= read -r api; do
    rel="${api#${PROJECT_DIR}/}"
    API_FILES+=("${rel}")
    BACKEND_API_COUNT=$((BACKEND_API_COUNT + 1))
  done < <(find "${PROJECT_DIR}" -type f \( -name "*Controller.java" -o -name "*Resource.java" -o -name "*Api.java" -o -name "*Endpoint.java" \) -not -path "*/target/*" 2>/dev/null)

  while IFS= read -r api; do
    rel="${api#${PROJECT_DIR}/}"
    if ! contains_in_array "${rel}" "${API_FILES[@]+"${API_FILES[@]}"}"; then
      API_FILES+=("${rel}")
      FRONTEND_API_FILES+=("${rel}")
      FRONTEND_API_COUNT=$((FRONTEND_API_COUNT + 1))
    fi
  done < <(find "${PROJECT_DIR}" -type f \( -name "*.ts" -o -name "*.tsx" -o -name "*.js" -o -name "*.jsx" -o -name "*.vue" \) \
    \( -path "*/src/api/*" -o -path "*/src/services/*" -o -path "*/src/service/*" -o -path "*/src/store/*" \) \
    -not -path "*/node_modules/*" -not -path "*/dist/*" -not -path "*/build/*" 2>/dev/null)

  while IFS= read -r routef; do
    rel="${routef#${PROJECT_DIR}/}"
    if ! contains_in_array "${rel}" "${FRONTEND_ROUTE_FILES[@]+"${FRONTEND_ROUTE_FILES[@]}"}"; then
      FRONTEND_ROUTE_FILES+=("${rel}")
    fi
    if ! contains_in_array "${rel}" "${API_FILES[@]+"${API_FILES[@]}"}"; then
      API_FILES+=("${rel}")
      FRONTEND_API_COUNT=$((FRONTEND_API_COUNT + 1))
    fi
  done < <(find "${PROJECT_DIR}" -type f \( -name "*route*.ts" -o -name "*route*.tsx" -o -name "router.ts" -o -name "router.js" \) \
    -not -path "*/node_modules/*" -not -path "*/dist/*" -not -path "*/build/*" 2>/dev/null)

  while IFS= read -r sql; do
    rel="${sql#${PROJECT_DIR}/}"
    SQL_FILES+=("${rel}")
  done < <(find "${PROJECT_DIR}" -type f -name "*.sql" -not -path "*/target/*" 2>/dev/null)
  if [[ -d "${PROJECT_DIR}/doc/sql" || ${#SQL_FILES[@]} -gt 0 ]]; then
    HAS_DOC_SQL=1
  fi

  while IFS= read -r openapi; do
    rel_openapi="${openapi#${PROJECT_DIR}/}"
    OPENAPI_FILES+=("${rel_openapi}")
    service_raw="${rel_openapi#spec_center/}"
    service_raw="${service_raw%%/*}"
    service_name="$(normalize_slug "${service_raw}")"
    if [[ -n "${service_raw}" && "${service_raw}" != "${rel_openapi}" && -n "${service_name}" ]]; then
      if [[ "${service_raw}" != "${service_name}" ]]; then
        BAD_SERVICE_DIR_HINTS+=("spec_center/${service_raw} -> spec_center/${service_name}")
      fi
      if ! contains_in_array "${service_name}" "${SERVICE_NAMES[@]+"${SERVICE_NAMES[@]}"}"; then
        SERVICE_NAMES+=("${service_name}")
      fi
    fi
  done < <(find "${PROJECT_DIR}/spec_center" -type f -path "*/contracts/openapi.yaml" 2>/dev/null || true)

  while IFS= read -r spec; do
    rel_spec="${spec#${PROJECT_DIR}/}"
    SPEC_FILES+=("${rel_spec}")
    service_raw="${rel_spec#spec_center/}"
    service_raw="${service_raw%%/*}"
    service_name="$(normalize_slug "${service_raw}")"
    if [[ -n "${service_raw}" && "${service_raw}" != "${rel_spec}" && -n "${service_name}" ]]; then
      if [[ "${service_raw}" != "${service_name}" ]]; then
        BAD_SERVICE_DIR_HINTS+=("spec_center/${service_raw} -> spec_center/${service_name}")
      fi
      if ! contains_in_array "${service_name}" "${SERVICE_NAMES[@]+"${SERVICE_NAMES[@]}"}"; then
        SERVICE_NAMES+=("${service_name}")
      fi
    fi
  done < <(find "${PROJECT_DIR}/spec_center" -type f -path "*/spec.md" 2>/dev/null || true)

  raw_service="$(basename "${PROJECT_DIR}")"
  SERVICE_SLUG="$(normalize_slug "${raw_service}")"
  if [[ -z "${SERVICE_SLUG}" ]]; then
    SERVICE_SLUG="service"
  fi
  if [[ ${#SERVICE_NAMES[@]} -eq 0 ]]; then
    SERVICE_NAMES+=("${SERVICE_SLUG}")
  fi

  if [[ "${BACKEND_API_COUNT}" -gt 0 && "${FRONTEND_API_COUNT}" -gt 0 ]]; then
    SCAN_STACK="hybrid"
  elif [[ "${BACKEND_API_COUNT}" -gt 0 ]]; then
    SCAN_STACK="backend"
  elif [[ "${FRONTEND_API_COUNT}" -gt 0 ]]; then
    SCAN_STACK="frontend"
  elif [[ ${#MODULE_DIRS[@]} -gt 0 ]]; then
    SCAN_STACK="backend"
  else
    SCAN_STACK="unknown"
  fi

  if [[ ${#BAD_SERVICE_DIR_HINTS[@]} -gt 0 ]]; then
    local hint
    for hint in "${BAD_SERVICE_DIR_HINTS[@]+"${BAD_SERVICE_DIR_HINTS[@]}"}"; do
      append_suggest "needs_manual_confirm: normalize duplicated service directory (${hint})"
    done
  fi
}

write_inventory() {
  local item idx
  {
    echo "# project inventory (cursor-tune)"
    echo
    echo "- target: ${PROJECT_DIR}"
    echo "- mode: ${TUNE_MODE}"
    echo "- modules_detected: ${#MODULE_DIRS[@]}"
    echo "- api_files_detected: ${#API_FILES[@]}"
    echo "- sql_files_detected: ${#SQL_FILES[@]}"
    echo "- settings_files_detected: ${#SETTINGS_FILES[@]}"
    echo "- openapi_files_detected: ${#OPENAPI_FILES[@]}"
    echo "- spec_files_detected: ${#SPEC_FILES[@]}"
    echo "- scan_stack: ${SCAN_STACK}"
    echo "- backend_api_candidates_detected: ${BACKEND_API_COUNT}"
    echo "- frontend_api_candidates_detected: ${FRONTEND_API_COUNT}"
    echo "- suggested_service_slug: ${SERVICE_SLUG}"
    echo

    echo "## Modules"
    if [[ ${#MODULE_DIRS[@]} -eq 0 ]]; then
      echo "- none"
    else
      idx=0
      for item in "${MODULE_DIRS[@]+"${MODULE_DIRS[@]}"}"; do
        idx=$((idx + 1))
        if [[ "${idx}" -le 30 ]]; then
          echo "- ${item}"
        fi
      done
      if [[ "${idx}" -gt 30 ]]; then
        echo "- ... (truncated)"
      fi
    fi
    echo

    echo "## API Candidate Files"
    if [[ ${#API_FILES[@]} -eq 0 ]]; then
      echo "- none"
    else
      idx=0
      for item in "${API_FILES[@]+"${API_FILES[@]}"}"; do
        idx=$((idx + 1))
        if [[ "${idx}" -le 50 ]]; then
          echo "- ${item}"
        fi
      done
      if [[ "${idx}" -gt 50 ]]; then
        echo "- ... (truncated)"
      fi
    fi
    echo

    echo "## SQL Files"
    if [[ ${#SQL_FILES[@]} -eq 0 ]]; then
      echo "- none"
    else
      idx=0
      for item in "${SQL_FILES[@]+"${SQL_FILES[@]}"}"; do
        idx=$((idx + 1))
        if [[ "${idx}" -le 50 ]]; then
          echo "- ${item}"
        fi
      done
      if [[ "${idx}" -gt 50 ]]; then
        echo "- ... (truncated)"
      fi
    fi
    echo

    echo "## Frontend Route Files"
    if [[ ${#FRONTEND_ROUTE_FILES[@]} -eq 0 ]]; then
      echo "- none"
    else
      idx=0
      for item in "${FRONTEND_ROUTE_FILES[@]+"${FRONTEND_ROUTE_FILES[@]}"}"; do
        idx=$((idx + 1))
        if [[ "${idx}" -le 40 ]]; then
          echo "- ${item}"
        fi
      done
      if [[ "${idx}" -gt 40 ]]; then
        echo "- ... (truncated)"
      fi
    fi
    echo
  } > "${INVENTORY_FILE}"
}

WORK_DIR="${PROJECT_DIR}"
if [[ "${DRY_RUN}" == "1" ]]; then
  WORK_DIR="$(mktemp -d)"
  mkdir -p "${WORK_DIR}"
fi

copy_if_exists_to_work() {
  local rel="$1"
  if [[ "${WORK_DIR}" == "${PROJECT_DIR}" ]]; then
    return 0
  fi
  if [[ -f "${PROJECT_DIR}/${rel}" ]]; then
    mkdir -p "${WORK_DIR}/$(dirname "${rel}")"
    cp "${PROJECT_DIR}/${rel}" "${WORK_DIR}/${rel}"
  fi
}

for rel in \
  ".cursor/hooks/hooks.json" \
  ".cursor/hooks/gates/config.sh" \
  ".cursor/rules/00-core.mdc" \
  ".cursor/rules/98-repo-scan-index.mdc" \
  ".cursor/rules/99-project-conventions.mdc" \
  ".cursor/commands/api-search.md" \
  ".cursor/commands/bridge-implement.md" \
  ".cursor/commands/init-scan.md" \
  ".cursor/commands/project-local-conventions.md" \
  "bin/cursor-tune" \
  "bin/cursor-bootstrap" \
  "bin/cursor-cleanup" \
  "spec_center/capability-registry.md" \
  "spec_center/_raw_contracts/README.md"
do
  copy_if_exists_to_work "${rel}"
done

ensure_file_content() {
  local rel="$1"
  local content="$2"
  local target="${WORK_DIR}/${rel}"
  mkdir -p "$(dirname "${target}")"

  if [[ ! -f "${target}" ]]; then
    printf "%s\n" "${content}" > "${target}"
    add_unique_file "${rel}"
    append_action "created: ${rel}"
    return 0
  fi

  if [[ "${TUNE_MODE}" == "safe" ]] && ! rg -q -F "managed-by: cursor-tune" "${target}"; then
    append_suggest "needs_manual_confirm: ${rel} exists without marker, skipped in safe mode"
    return 0
  fi

  printf "%s\n" "${content}" > "${target}"
  add_unique_file "${rel}"
  append_action "patched: ${rel}"
}

upsert_managed_block() {
  local rel="$1"
  local block_key="$2"
  local block_content="$3"
  local target="${WORK_DIR}/${rel}"
  local begin_marker end_marker
  begin_marker="<!-- managed-by: cursor-tune begin:${block_key} -->"
  end_marker="<!-- managed-by: cursor-tune end:${block_key} -->"

  mkdir -p "$(dirname "${target}")"
  if [[ ! -f "${target}" ]]; then
    printf "%s\n\n%s\n%s\n%s\n" "# managed-by: cursor-tune" "${begin_marker}" "${block_content}" "${end_marker}" > "${target}"
    add_unique_file "${rel}"
    append_action "created: ${rel}"
    return 0
  fi

  python3 - "${target}" "${begin_marker}" "${end_marker}" "${block_content}" <<'PY'
import re, sys
p, begin, end, body = sys.argv[1], sys.argv[2], sys.argv[3], sys.argv[4]
s = open(p, encoding="utf-8").read()
block = f"{begin}\n{body}\n{end}"
pattern = re.compile(re.escape(begin) + r".*?" + re.escape(end), re.S)
if pattern.search(s):
  s = pattern.sub(block, s, count=1)
else:
  if not s.endswith("\n"):
    s += "\n"
  s += "\n" + block + "\n"
open(p, "w", encoding="utf-8").write(s)
PY
  add_unique_file "${rel}"
  append_action "patched: ${rel} (managed block: ${block_key})"
}

build_list_markdown() {
  local max_items="$1"
  shift
  local -a items=("$@")
  local out="" i=0 item
  if [[ ${#items[@]} -eq 0 ]]; then
    printf -- "- none"
    return 0
  fi
  for item in "${items[@]+"${items[@]}"}"; do
    i=$((i + 1))
    if [[ "${i}" -le "${max_items}" ]]; then
      out="${out}- ${item}"$'\n'
    fi
  done
  if [[ "${i}" -gt "${max_items}" ]]; then
    out="${out}- ... (truncated)"$'\n'
  fi
  printf "%s" "${out%$'\n'}"
}

tune_cursor_rules_and_commands() {
  local module_list api_list sql_list cmd_block stack_code_hint endpoint_hint
  module_list="$(build_list_markdown 12 "${MODULE_DIRS[@]+"${MODULE_DIRS[@]}"}")"
  api_list="$(build_list_markdown 15 "${API_FILES[@]+"${API_FILES[@]}"}")"
  sql_list="$(build_list_markdown 12 "${SQL_FILES[@]+"${SQL_FILES[@]}"}")"
  stack_code_hint="控制器与实现代码"
  endpoint_hint="\`spec_center/${SERVICE_SLUG}/contracts/openapi.yaml\`"
  if [[ "${SCAN_STACK}" == "frontend" ]]; then
    stack_code_hint="前端 API 调用与页面路由代码"
  elif [[ "${SCAN_STACK}" == "hybrid" ]]; then
    stack_code_hint="控制器实现 + 前端 API 调用/路由代码"
  fi

  upsert_managed_block ".cursor/rules/00-core.mdc" "scan-derived-priority" "$(cat <<EOF
## 扫描校准（cursor-tune 自动维护）
- 服务标识：\`${SERVICE_SLUG}\`
- 工程类型：\`${SCAN_STACK}\`
- 优先检索顺序（用于语义搜索）：
  1) \`spec_center/capability-registry.md\`
  2) ${endpoint_hint}
  3) ${stack_code_hint}
  4) \`spec_center/_raw_contracts/**\`（仅溯源）
- 关键约束：新增/变更 API 后，必须同步更新 capability-registry + openapi + spec。
EOF
)"

  upsert_managed_block ".cursor/rules/98-repo-scan-index.mdc" "repo-scan-index" "$(cat <<EOF
# managed-by: cursor-tune

## 扫描快照
- scan_stack: ${SCAN_STACK}
- modules_detected: ${#MODULE_DIRS[@]}
- api_candidates_detected: ${#API_FILES[@]}
- backend_api_candidates_detected: ${BACKEND_API_COUNT}
- frontend_api_candidates_detected: ${FRONTEND_API_COUNT}
- sql_files_detected: ${#SQL_FILES[@]}
- settings_file: ${SETTINGS_FILE:-none}

## 模块列表（Top 12）
${module_list}

## API 候选文件（Top 15）
${api_list}

## SQL 文件（Top 12）
${sql_list}
EOF
)"

  cmd_block="$(cat <<EOF
### 扫描校准（cursor-tune 自动维护）
- 默认服务：\`${SERVICE_SLUG}\`
- 先查：\`spec_center/capability-registry.md\`
- 再查：\`spec_center/${SERVICE_SLUG}/contracts/openapi.yaml\`
- 若语义检索命中不足，补充 \`Synonyms\` 与 \`Notes\`，并回写 \`${SERVICE_SLUG}/spec.md\`
EOF
)"
  upsert_managed_block ".cursor/commands/api-search.md" "scan-derived-search" "${cmd_block}"

  cmd_block="$(cat <<EOF
### 扫描校准（cursor-tune 自动维护）
- 当前服务：\`${SERVICE_SLUG}\`
- 实施前先对齐三件套：
  - \`spec_center/capability-registry.md\`
  - \`spec_center/${SERVICE_SLUG}/spec.md\`
  - \`spec_center/${SERVICE_SLUG}/contracts/openapi.yaml\`
- 若接口已改动但三件套未同步，先补齐再进入实现。
EOF
)"
  upsert_managed_block ".cursor/commands/bridge-implement.md" "scan-derived-bridge" "${cmd_block}"

  cmd_block="$(cat <<EOF
### 扫描校准（cursor-tune 自动维护）
- 发现服务：\`${SERVICE_SLUG}\`
- 必检项：
  - \`spec_center/${SERVICE_SLUG}/spec.md\` 是否存在并与 capability-registry 对齐
  - \`spec_center/${SERVICE_SLUG}/contracts/openapi.yaml\` 是否含 \`x-capability-links\`
  - \`spec_center/capability-registry.md\` 是否存在 Endpoint + Synonyms
EOF
)"
  upsert_managed_block ".cursor/commands/init-scan.md" "scan-derived-init-scan" "${cmd_block}"
}

scan_project
write_inventory

for rel in "${OPENAPI_FILES[@]+"${OPENAPI_FILES[@]}"}"; do
  copy_if_exists_to_work "${rel}"
done
for rel in "${SPEC_FILES[@]+"${SPEC_FILES[@]}"}"; do
  copy_if_exists_to_work "${rel}"
done

RULES_CONTENT="$(cat <<EOF
# managed-by: cursor-tune

## 本工程约定（自动维护）
- 模式：${TUNE_MODE}
- 多模块：$( [[ "${MULTI_MODULE}" == "1" ]] && echo yes || echo no )
- maven settings：$( [[ -n "${SETTINGS_FILE}" ]] && echo "${SETTINGS_FILE}" || echo none )
- 迁移目录补充：$( [[ "${HAS_DOC_SQL}" == "1" ]] && echo "doc/sql/" || echo none )
- 模块数量：${#MODULE_DIRS[@]}
- API 候选数量：${#API_FILES[@]}
- 清单文件：_cursor_init/project-inventory.md
EOF
)"
ensure_file_content ".cursor/rules/99-project-conventions.mdc" "${RULES_CONTENT}"

COMMANDS_CONTENT="$(cat <<EOF
# managed-by: cursor-tune

## Project Local Conventions
- 当前调优模式：${TUNE_MODE}
- 若存在 settings-*.xml，优先确认单测命令是否需要 -s 参数。
- 若检测到多模块结构，校准 API/DB 路径正则时保留模块前缀。
- 若存在 doc/sql/，建议在 DB gate 中补充迁移目录识别。
- 先阅读 _cursor_init/project-inventory.md，再决定 spec_center 的能力拆分颗粒度。
EOF
)"
ensure_file_content ".cursor/commands/project-local-conventions.md" "${COMMANDS_CONTENT}"
tune_cursor_rules_and_commands

maybe_create_config_from_template() {
  local rel=".cursor/hooks/gates/config.sh"
  local target="${WORK_DIR}/${rel}"
  if [[ ! -f "${target}" ]]; then
    mkdir -p "$(dirname "${target}")"
    cp "${TEMPLATE_CONFIG}" "${target}"
    add_unique_file "${rel}"
    append_action "created: ${rel}"
  fi
}

replace_or_append_export() {
  local file="$1"
  local var="$2"
  local val="$3"
  if rg -q "^[[:space:]]*export[[:space:]]+${var}=" "${file}"; then
    python3 - "$file" "$var" "$val" <<'PY'
import re,sys
p,var,val=sys.argv[1],sys.argv[2],sys.argv[3]
s=open(p,encoding="utf-8").read()
s=re.sub(rf'^\s*export\s+{re.escape(var)}=.*$', f'export {var}="{val}"', s, flags=re.M)
open(p,"w",encoding="utf-8").write(s)
PY
  else
    printf '\nexport %s="%s"\n' "${var}" "${val}" >> "${file}"
  fi
}

tune_config() {
  local rel=".cursor/hooks/gates/config.sh"
  local target="${WORK_DIR}/${rel}"
  maybe_create_config_from_template

  if [[ "${TUNE_MODE}" == "safe" ]] && ! rg -q -F "managed-by: cursor-tune" "${target}"; then
    append_suggest "needs_manual_confirm: ${rel} exists without marker, skipped in safe mode"
    return 0
  fi

  if [[ "${SCAN_STACK}" != "frontend" && "${MULTI_MODULE}" == "1" ]]; then
    replace_or_append_export "${target}" "CURSOR_API_DIR_WHITELIST_RE" ".*/src/main/java/.*/(controller|api|web|rest|resource)/|.*/src/main/java/.*/(dto|vo|form|request|response)/"
    replace_or_append_export "${target}" "CURSOR_SRC_MAIN_JAVA" "."
    replace_or_append_export "${target}" "CURSOR_SRC_MAIN_RESOURCES" "."
    replace_or_append_export "${target}" "CURSOR_DB_GATE_FIND_MAXDEPTH" "14"
  fi
  if [[ "${SCAN_STACK}" != "frontend" && "${HAS_DOC_SQL}" == "1" ]]; then
    replace_or_append_export "${target}" "CURSOR_MIGRATION_DIR_EXTRA_RE" "(^|/)(migration|migrations)/|(^|/)doc/sql/"
  fi
  add_unique_file "${rel}"
  append_action "patched: ${rel}"
}

tune_hooks_json() {
  local rel=".cursor/hooks/hooks.json"
  local target="${WORK_DIR}/${rel}"

  if [[ ! -f "${target}" ]]; then
    mkdir -p "$(dirname "${target}")"
    if [[ "${SCAN_STACK}" == "frontend" ]]; then
      cat > "${target}" <<'EOF'
{
  "version": 1,
  "hooks": [
    {
      "name": "frontend:lint",
      "when": "pre_commit",
      "run": "npm run lint"
    }
  ]
}
EOF
    else
      cat > "${target}" <<'EOF'
{
  "version": 1,
  "hooks": [
    {
      "name": "backend:unit-test",
      "when": "pre_commit",
      "run": "mvn -q test"
    }
  ]
}
EOF
    fi
    add_unique_file "${rel}"
    append_action "created: ${rel}"
  fi

  if [[ "${SCAN_STACK}" == "frontend" ]]; then
    append_suggest "hint: frontend stack detected, keep hooks aligned with package scripts (lint/test/build)"
    return 0
  fi

  if [[ -z "${SETTINGS_FILE}" ]]; then
    append_suggest "hint: no settings-*.xml detected, keep backend:unit-test as-is"
    return 0
  fi

  if [[ "${TUNE_MODE}" == "safe" ]]; then
    append_suggest "needs_manual_confirm: detected ${SETTINGS_FILE}, evaluate adding -s to backend:unit-test"
    return 0
  fi

  python3 - "${target}" "${SETTINGS_FILE}" <<'PY'
import json,sys
p,settings=sys.argv[1],sys.argv[2]
obj=json.load(open(p,encoding="utf-8"))
hooks=obj.get("hooks",[])
found=False
for h in hooks:
  if h.get("name")=="backend:unit-test":
    run=h.get("run","mvn -q test")
    if "-s " not in run:
      h["run"]=f"{run} -s {settings}"
    found=True
if not found:
  hooks.append({"name":"backend:unit-test","when":"pre_commit","run":f"mvn -q test -s {settings}"})
obj["hooks"]=hooks
json.dump(obj,open(p,"w",encoding="utf-8"),ensure_ascii=False,indent=2)
PY
  add_unique_file "${rel}"
  append_action "patched: ${rel} (added -s ${SETTINGS_FILE})"
}

tune_bin_wrappers() {
  local wrapper_name target_script
  for wrapper_name in cursor-tune cursor-bootstrap cursor-cleanup; do
    target_script="${ROOT_DIR}/bin/${wrapper_name}"
    ensure_file_content "bin/${wrapper_name}" "$(cat <<EOF
#!/usr/bin/env bash
set -euo pipefail

BOOTSTRAP_REPO="${ROOT_DIR}"
TARGET_SCRIPT="\${BOOTSTRAP_REPO}/bin/${wrapper_name}"

if [[ ! -f "\${TARGET_SCRIPT}" ]]; then
  echo "[${wrapper_name} wrapper] missing script: \${TARGET_SCRIPT}"
  exit 1
fi

has_target_flag=0
for arg in "\$@"; do
  if [[ "\${arg}" == "--target-dir" || "\${arg}" == "--use-current-dir" ]]; then
    has_target_flag=1
    break
  fi
done

if [[ "\${has_target_flag}" == "1" ]]; then
  exec bash "\${TARGET_SCRIPT}" "\$@"
else
  exec bash "\${TARGET_SCRIPT}" --target-dir "\$(pwd)" "\$@"
fi
EOF
)"
  done
}

upsert_spec_center() {
  local service module api rel_module module_token openapi_file spec_file
  local cap_tmp openapi_tmp spec_tmp cap_rows api_rows
  local cap_id class_name class_root cap_slug cap_words endpoint_hint owner_service
  local link_tmp link_line link_id link_cap link_ep link_src link_count
  cap_tmp="$(mktemp)"
  link_tmp="$(mktemp)"
  cap_rows=0

  {
    echo "# Capability Registry（能力索引｜给 /api-search 用）"
    echo
    echo "## OwnerType 定义（必须）"
    echo "- \`internal-self\`：本工程自有服务能力（优先复用）"
    echo "- \`internal-other\`：公司内其他工程服务能力（次优先）"
    echo "- \`external-vendor\`：公司外部第三方厂商能力（最后考虑）"
    echo
    echo "## /api-search 推荐检索顺序（必须）"
    echo "1. \`capability-registry.md\`（先按 \`OwnerType\` 优先级检索）"
    echo "2. \`<service>/contracts/openapi.yaml\`（治理契约）"
    echo "3. 代码实现（controller/service 或 src/api/pages）"
    echo "4. \`_raw_contracts/**\`（仅用于溯源、冲突排查、补充信息）"
    echo
    echo "同义词示例："
    echo "- 隐患 = hazard, risk, defect"
    echo "- 检查 = inspection, check, audit"
    echo
    echo "> managed-by: cursor-tune"
    echo "> source: _cursor_init/project-inventory.md"
    echo "> modules_detected: ${#MODULE_DIRS[@]}"
    echo "> api_candidates_detected: ${#API_FILES[@]}"
    echo
    echo "能力表（由 cursor-tune 扫描生成，需人工确认后用于语义搜索）："
    echo
    echo "| Capability | OwnerType | OwnerService | OwnerTeam | Endpoint | SLA/Tier | Notes | Synonyms |"
    echo "|---|---|---|---|---|---|---|---|"
  } > "${cap_tmp}"

  api_rows=0
  for api in "${API_FILES[@]+"${API_FILES[@]}"}"; do
    class_name="$(basename "${api}")"
    class_name="${class_name%.java}"
    class_name="${class_name%.kt}"
    class_name="${class_name%.ts}"
    class_name="${class_name%.tsx}"
    class_name="${class_name%.js}"
    class_name="${class_name%.jsx}"
    class_name="${class_name%.vue}"
    class_root="${class_name%Controller}"
    class_root="${class_root%Resource}"
    class_root="${class_root%Endpoint}"
    class_root="${class_root%Api}"
    class_root="${class_root%Service}"
    class_root="${class_root%Route}"
    if [[ -z "${class_root}" ]]; then
      class_root="${class_name}"
    fi
    cap_words="$(printf "%s" "${class_root}" | sed -E 's/([a-z0-9])([A-Z])/\1 \2/g')"
    cap_slug="$(normalize_slug "${class_root}")"
    [[ -z "${cap_slug}" ]] && cap_slug="capability"
    endpoint_hint="/api/${cap_slug}"
    if [[ "${api}" == *"/src/pages/"* || "${api}" == *"/src/routes/"* || "${api}" == *"/router"* ]]; then
      endpoint_hint="/page/${cap_slug}"
    fi
    cap_id="cap.${cap_slug}.$(printf "%03d" $((api_rows + 1)))"
    owner_service="${SERVICE_SLUG}"
    if [[ "${api}" == *"/${SERVICE_SLUG}/"* ]]; then
      owner_service="${SERVICE_SLUG}"
    fi
    printf "| %s 管理能力 | %s | %s | todo | %s | core | id=%s; source=%s; spec=%s/spec.md | %s, %s |\n" \
      "${cap_words}" "internal-self" "${owner_service}" "${endpoint_hint}" "${cap_id}" "${api}" "${owner_service}" "${cap_words}" "${cap_slug}" >> "${cap_tmp}"
    printf "%s|%s 管理能力|%s|%s\n" "${cap_id}" "${cap_words}" "${endpoint_hint}" "${api}" >> "${link_tmp}"
    cap_rows=$((cap_rows + 1))
    api_rows=$((api_rows + 1))
    if [[ "${api_rows}" -ge 80 ]]; then
      break
    fi
  done

  if [[ "${cap_rows}" -eq 0 ]]; then
    for module in "${MODULE_DIRS[@]+"${MODULE_DIRS[@]}"}"; do
      module_token="$(normalize_slug "${module}")"
      [[ -z "${module_token}" ]] && module_token="root"
      if [[ "${SCAN_STACK}" == "frontend" ]]; then
        printf "| %s 模块能力占位 | internal-self | %s | todo | /page/%s | core | source=%s/src/{api,services,pages,routes}/**; spec=%s/spec.md | %s |\n" \
          "${module_token}" "${SERVICE_SLUG}" "${module_token}" "${module}" "${SERVICE_SLUG}" "${module_token}" >> "${cap_tmp}"
      else
        printf "| %s 模块能力占位 | internal-self | %s | todo | /api/%s | core | source=%s/src/main/java/**/(controller|api|resource)/**; spec=%s/spec.md | %s |\n" \
          "${module_token}" "${SERVICE_SLUG}" "${module_token}" "${module}" "${SERVICE_SLUG}" "${module_token}" >> "${cap_tmp}"
      fi
      cap_rows=$((cap_rows + 1))
    done
  fi

  if [[ "${cap_rows}" -eq 0 ]]; then
    if [[ "${SCAN_STACK}" == "frontend" ]]; then
      echo "| root 模块能力占位 | internal-self | ${SERVICE_SLUG} | todo | /page/root | core | source=src/{api,services,pages,routes}/**; spec=${SERVICE_SLUG}/spec.md | root |" >> "${cap_tmp}"
      printf "cap.root.001|root 模块能力占位|/page/root|src/{api,services,pages,routes}/**\n" >> "${link_tmp}"
    else
      echo "| root 模块能力占位 | internal-self | ${SERVICE_SLUG} | todo | /api/root | core | source=src/main/java/**/(controller|api|resource)/**; spec=${SERVICE_SLUG}/spec.md | root |" >> "${cap_tmp}"
      printf "cap.root.001|root 模块能力占位|/api/root|src/main/java/**/(controller|api|resource)/**\n" >> "${link_tmp}"
    fi
  fi

  {
    echo
    echo "## API Candidate Hints (top 30)"
  } >> "${cap_tmp}"
  api_rows=0
  if [[ ${#API_FILES[@]} -eq 0 ]]; then
    echo "- none" >> "${cap_tmp}"
  else
    for api in "${API_FILES[@]+"${API_FILES[@]}"}"; do
      api_rows=$((api_rows + 1))
      if [[ "${api_rows}" -le 30 ]]; then
        echo "- ${api}" >> "${cap_tmp}"
      fi
    done
    if [[ "${api_rows}" -gt 30 ]]; then
      echo "- ... (truncated)" >> "${cap_tmp}"
    fi
  fi

  ensure_file_content "spec_center/capability-registry.md" "$(cat "${cap_tmp}")"
  rm -f "${cap_tmp}"

  ensure_file_content "spec_center/_raw_contracts/README.md" "$(cat <<'EOF'
# _raw_contracts

managed-by: cursor-tune

当前状态：待导入原始契约。

建议：
- 将外部系统原始 openapi/json/yaml 放入本目录。
- 在 capability-registry 中标记 source=external-* 并补充复用依据。
EOF
)"

  for service in "${SERVICE_NAMES[@]+"${SERVICE_NAMES[@]}"}"; do
    openapi_tmp="$(mktemp)"
    spec_tmp="$(mktemp)"
    {
      echo "openapi: 3.0.0"
      echo "x-generated-by: cursor-tune"
      echo "x-inventory:"
      echo "  modules_detected: ${#MODULE_DIRS[@]}"
      echo "  api_candidates_detected: ${#API_FILES[@]}"
      echo "  source_file: _cursor_init/project-inventory.md"
      echo "info:"
      echo "  title: ${service}"
      echo "  version: 0.0.1"
      echo "paths:"
      link_count=0
      while IFS= read -r link_line; do
        [[ -z "${link_line}" ]] && continue
        link_id="${link_line%%|*}"
        link_cap="${link_line#*|}"
        link_cap="${link_cap%%|*}"
        link_ep="${link_line#*|*|}"
        link_ep="${link_ep%%|*}"
        link_src="${link_line##*|}"
        link_count=$((link_count + 1))
        if [[ "${link_count}" -le 20 ]]; then
          echo "  ${link_ep}:"
          echo "    get:"
          echo "      operationId: ${link_id}"
          echo "      summary: ${link_cap}"
          echo "      tags:"
          echo "        - ${service}"
          echo "      x-source-file: ${link_src}"
          echo "      responses:"
          echo "        '200':"
          echo "          description: TODO: define response schema."
        fi
      done < "${link_tmp}"
      if [[ "${link_count}" -eq 0 ]]; then
        echo "  /api/root:"
        echo "    get:"
        echo "      operationId: cap.root.001"
        echo "      summary: root 模块能力占位"
        echo "      tags:"
        echo "        - ${service}"
        echo "      responses:"
        echo "        '200':"
        echo "          description: TODO: define response schema."
      fi
      echo
      echo "tags:"
      if [[ ${#MODULE_DIRS[@]} -eq 0 ]]; then
        echo "  - name: root"
        echo "    description: TODO: map root module endpoints."
      else
        for module in "${MODULE_DIRS[@]+"${MODULE_DIRS[@]}"}"; do
          rel_module="${module}"
          [[ "${rel_module}" == "root" ]] && rel_module="root"
          echo "  - name: ${rel_module}"
          echo "    description: TODO: map ${rel_module} endpoints."
        done
      fi
      echo
      echo "x-api-candidate-files:"
      if [[ ${#API_FILES[@]} -eq 0 ]]; then
        echo "  - none"
      else
        api_rows=0
        for api in "${API_FILES[@]+"${API_FILES[@]}"}"; do
          api_rows=$((api_rows + 1))
          if [[ "${api_rows}" -le 40 ]]; then
            echo "  - ${api}"
          fi
        done
        if [[ "${api_rows}" -gt 40 ]]; then
          echo "  - ... (truncated)"
        fi
      fi
      echo
      echo "x-capability-links:"
      link_count=0
      while IFS= read -r link_line; do
        [[ -z "${link_line}" ]] && continue
        link_id="${link_line%%|*}"
        link_cap="${link_line#*|}"
        link_cap="${link_cap%%|*}"
        link_ep="${link_line#*|*|}"
        link_ep="${link_ep%%|*}"
        link_src="${link_line##*|}"
        link_count=$((link_count + 1))
        if [[ "${link_count}" -le 40 ]]; then
          echo "  - capability_id: ${link_id}"
          echo "    capability: ${link_cap}"
          echo "    endpoint: ${link_ep}"
          echo "    source_file: ${link_src}"
          echo "    registry_ref: spec_center/capability-registry.md"
          echo "    spec_ref: spec_center/${service}/spec.md"
        fi
      done < "${link_tmp}"
      if [[ "${link_count}" -eq 0 ]]; then
        echo "  - capability_id: cap.root.001"
        echo "    capability: root 模块能力占位"
        echo "    endpoint: /api/root"
        echo "    source_file: src/main/java/**/(controller|api|resource)/**"
        echo "    registry_ref: spec_center/capability-registry.md"
        echo "    spec_ref: spec_center/${service}/spec.md"
      fi
    } > "${openapi_tmp}"
    openapi_file="spec_center/${service}/contracts/openapi.yaml"
    ensure_file_content "${openapi_file}" "$(cat "${openapi_tmp}")"
    rm -f "${openapi_tmp}"

    {
      echo "# ${service}｜服务能力规格（自动草案）"
      echo
      echo "> managed-by: cursor-tune"
      echo "> source: _cursor_init/project-inventory.md"
      echo
      echo "## 1) Why（为什么做）"
      echo "- 统一该服务对外能力定义，提升复用检索命中率。"
      echo "- 让 capability-registry、openapi、实现代码三者保持可追溯。"
      echo
      echo "## 2) What（做什么）"
      echo "- in scope：基于 controller/resource/api 扫描得到的能力候选。"
      echo "- out of scope：未在 inventory 中出现的历史隐式接口。"
      echo
      echo "## 3) Capability 联动映射（关键）"
      echo "| CapabilityID | Capability | Endpoint | Registry | OpenAPI | Source |"
      echo "|---|---|---|---|---|---|"
      link_count=0
      while IFS= read -r link_line; do
        [[ -z "${link_line}" ]] && continue
        link_id="${link_line%%|*}"
        link_cap="${link_line#*|}"
        link_cap="${link_cap%%|*}"
        link_ep="${link_line#*|*|}"
        link_ep="${link_ep%%|*}"
        link_src="${link_line##*|}"
        link_count=$((link_count + 1))
        if [[ "${link_count}" -le 40 ]]; then
          printf "| %s | %s | %s | capability-registry.md | %s/contracts/openapi.yaml | %s |\n" \
            "${link_id}" "${link_cap}" "${link_ep}" "${service}" "${link_src}"
        fi
      done < "${link_tmp}"
      if [[ "${link_count}" -eq 0 ]]; then
        echo "| cap.root.001 | root 模块能力占位 | /api/root | capability-registry.md | ${service}/contracts/openapi.yaml | src/main/java/**/(controller|api|resource)/** |"
      fi
      echo
      echo "## 4) API / Contract 影响"
      echo "- 契约文件：\`${service}/contracts/openapi.yaml\`"
      echo "- 能力索引：\`capability-registry.md\`"
      echo "- 盘点来源：\`_cursor_init/project-inventory.md\`"
      echo
      echo "## 5) DoD（完成定义）"
      echo "- [ ] capability-registry 的 Capability 与 Endpoint 已对齐 openapi"
      echo "- [ ] openapi 的 x-capability-links 可回溯到 registry 与 spec"
      echo "- [ ] 关键能力补齐了 Notes/Synonyms（支持语义搜索）"
    } > "${spec_tmp}"
    spec_file="spec_center/${service}/spec.md"
    ensure_file_content "${spec_file}" "$(cat "${spec_tmp}")"
    rm -f "${spec_tmp}"
  done
  rm -f "${link_tmp}"
}

tune_config
tune_hooks_json
tune_bin_wrappers
upsert_spec_center

TMP_DIFF_DIR="$(mktemp -d)"
cleanup() {
  rm -rf "${TMP_DIFF_DIR}"
  if [[ "${DRY_RUN}" == "1" ]]; then
    rm -rf "${WORK_DIR}"
  fi
}
trap cleanup EXIT

gen_diff_for_file() {
  local rel="$1"
  local old="${PROJECT_DIR}/${rel}"
  local new="${WORK_DIR}/${rel}"
  if [[ -f "${old}" && -f "${new}" ]]; then
    diff -u "${old}" "${new}" || true
  elif [[ ! -f "${old}" && -f "${new}" ]]; then
    diff -u /dev/null "${new}" || true
  fi
}

: > "${DIFF_FILE}"
for rel in "${CHANGED_FILES[@]+"${CHANGED_FILES[@]}"}"; do
  gen_diff_for_file "${rel}" >> "${DIFF_FILE}"
done

if [[ "${DRY_RUN}" != "1" && "${WORK_DIR}" != "${PROJECT_DIR}" ]]; then
  for rel in "${CHANGED_FILES[@]+"${CHANGED_FILES[@]}"}"; do
    mkdir -p "${PROJECT_DIR}/$(dirname "${rel}")"
    cp "${WORK_DIR}/${rel}" "${PROJECT_DIR}/${rel}"
  done
fi

{
  echo "# cursor-tune report"
  echo
  echo "- mode: ${TUNE_MODE}"
  echo "- dry_run: $( [[ "${DRY_RUN}" == "1" ]] && echo yes || echo no )"
  echo "- target: ${PROJECT_DIR}"
  echo "- multi_module: $( [[ "${MULTI_MODULE}" == "1" ]] && echo yes || echo no )"
  echo "- doc_sql: $( [[ "${HAS_DOC_SQL}" == "1" ]] && echo yes || echo no )"
  echo "- scan_stack: ${SCAN_STACK}"
  echo "- settings_file: ${SETTINGS_FILE:-none}"
  echo "- modules_detected: ${#MODULE_DIRS[@]}"
  echo "- api_candidates_detected: ${#API_FILES[@]}"
  echo "- backend_api_candidates_detected: ${BACKEND_API_COUNT}"
  echo "- frontend_api_candidates_detected: ${FRONTEND_API_COUNT}"
  echo "- sql_files_detected: ${#SQL_FILES[@]}"
  echo "- service_slug: ${SERVICE_SLUG}"
  echo
  echo "## Applied (upsert)"
  if [[ ${#ACTION_LOG[@]} -eq 0 ]]; then
    echo "- none"
  else
    for line in "${ACTION_LOG[@]+"${ACTION_LOG[@]}"}"; do
      echo "- ${line}"
    done
  fi
  echo
  echo "## Suggestions"
  if [[ ${#SUGGEST_LOG[@]} -eq 0 ]]; then
    echo "- none"
  else
    for line in "${SUGGEST_LOG[@]+"${SUGGEST_LOG[@]}"}"; do
      echo "- ${line}"
    done
  fi
  echo
  echo "## Outputs"
  echo "- ${REPORT_FILE}"
  echo "- ${DIFF_FILE}"
  echo "- ${INVENTORY_FILE}"
} > "${REPORT_FILE}"

echo "[cursor-tune] done"
echo "- report: ${REPORT_FILE}"
echo "- diff: ${DIFF_FILE}"
echo "- inventory: ${INVENTORY_FILE}"
