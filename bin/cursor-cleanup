#!/usr/bin/env bash
set -euo pipefail

usage() {
  echo "Usage:"
  echo "  bash bin/cursor-cleanup --target-dir <path> [options]"
  echo "  bash bin/cursor-cleanup --use-current-dir [options]"
  echo
  echo "Options:"
  echo "  --target-dir <path>                 Target project root (required unless --use-current-dir)"
  echo "  --use-current-dir                   Use current directory as target project root"
  echo "  --include-bootstrap-output          Include _cursor_init cleanup (default: on)"
  echo "  --no-bootstrap-output               Do not clean _cursor_init"
  echo "  --include-spec-center-placeholders  Include marker-based spec_center placeholder cleanup"
  echo "  --include-cursor-scaffold           Include scaffold-created .cursor files (safe mode)"
  echo "  --include-cursor-scaffold-force     Force-remove scaffold .cursor files by template list"
  echo "  --apply                             Execute deletion (default: dry-run preview only)"
}

TARGET_DIR=""
USE_CURRENT_DIR=0
INCLUDE_BOOTSTRAP_OUTPUT=1
INCLUDE_SPEC_CENTER_PLACEHOLDERS=0
INCLUDE_CURSOR_SCAFFOLD=0
INCLUDE_CURSOR_SCAFFOLD_FORCE=0
APPLY=0

while [[ $# -gt 0 ]]; do
  case "$1" in
    --target-dir)
      TARGET_DIR="${2:-}"
      shift 2
      ;;
    --use-current-dir)
      USE_CURRENT_DIR=1
      shift
      ;;
    --include-bootstrap-output)
      INCLUDE_BOOTSTRAP_OUTPUT=1
      shift
      ;;
    --no-bootstrap-output)
      INCLUDE_BOOTSTRAP_OUTPUT=0
      shift
      ;;
    --include-spec-center-placeholders)
      INCLUDE_SPEC_CENTER_PLACEHOLDERS=1
      shift
      ;;
    --include-cursor-scaffold)
      INCLUDE_CURSOR_SCAFFOLD=1
      shift
      ;;
    --include-cursor-scaffold-force)
      INCLUDE_CURSOR_SCAFFOLD=1
      INCLUDE_CURSOR_SCAFFOLD_FORCE=1
      shift
      ;;
    --apply)
      APPLY=1
      shift
      ;;
    -h|--help)
      usage
      exit 0
      ;;
    *)
      echo "Unknown option: $1"
      usage
      exit 1
      ;;
  esac
done

if [[ -n "${TARGET_DIR}" && "${USE_CURRENT_DIR}" == "1" ]]; then
  echo "Use either --target-dir or --use-current-dir, not both."
  exit 1
fi

if [[ -z "${TARGET_DIR}" && "${USE_CURRENT_DIR}" != "1" ]]; then
  echo "Missing target directory. Use --target-dir <path> or --use-current-dir."
  exit 1
fi

if [[ "${USE_CURRENT_DIR}" == "1" ]]; then
  TARGET_DIR="."
fi

if [[ ! -d "${TARGET_DIR}" ]]; then
  echo "Target directory does not exist: ${TARGET_DIR}"
  exit 1
fi

PROJECT_DIR="$(cd "${TARGET_DIR}" && pwd)"
ROOT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")/.." && pwd)"
declare -a DELETE_PATHS=()

add_delete_path() {
  local p="$1"
  local e
  for e in "${DELETE_PATHS[@]+"${DELETE_PATHS[@]}"}"; do
    if [[ "${e}" == "${p}" ]]; then
      return 0
    fi
  done
  DELETE_PATHS+=("${p}")
}

if [[ "${INCLUDE_BOOTSTRAP_OUTPUT}" == "1" ]]; then
  if [[ -d "${PROJECT_DIR}/_cursor_init" ]]; then
    add_delete_path "${PROJECT_DIR}/_cursor_init"
  fi
fi

if [[ "${INCLUDE_CURSOR_SCAFFOLD}" == "1" ]]; then
  # Safe mode: remove only files that are still byte-identical to templates.
  # Force mode: remove by template path list even if modified.
  for mode in backend frontend; do
    template_root="${ROOT_DIR}/templates/${mode}"
    if [[ ! -d "${template_root}/.cursor" ]]; then
      continue
    fi
    while IFS= read -r tf; do
      if [[ ! -f "${tf}" ]]; then
        continue
      fi
      rel="${tf#${template_root}/}"
      target_file="${PROJECT_DIR}/${rel}"
      if [[ ! -f "${target_file}" ]]; then
        continue
      fi
      if [[ "${INCLUDE_CURSOR_SCAFFOLD_FORCE}" == "1" ]]; then
        add_delete_path "${target_file}"
      else
        if cmp -s "${tf}" "${target_file}"; then
          add_delete_path "${target_file}"
        fi
      fi
    done < <(find "${template_root}/.cursor" -type f 2>/dev/null)
  done
fi

if [[ "${INCLUDE_SPEC_CENTER_PLACEHOLDERS}" == "1" ]]; then
  capability_file="${PROJECT_DIR}/spec_center/capability-registry.md"
  raw_readme="${PROJECT_DIR}/spec_center/_raw_contracts/README.md"

  if [[ -f "${capability_file}" ]] && rg -q -F "Auto-generated minimal skeleton by cursor-bootstrap --enrich-spec-center." "${capability_file}"; then
    add_delete_path "${capability_file}"
  fi
  if [[ -f "${raw_readme}" ]] && rg -q -F "Generated by cursor-bootstrap --enrich-spec-center." "${raw_readme}"; then
    add_delete_path "${raw_readme}"
  fi

  declare -a openapi_files=()
  shopt -s nullglob
  openapi_files=("${PROJECT_DIR}"/spec_center/*/contracts/openapi.yaml)
  shopt -u nullglob
  for f in "${openapi_files[@]+"${openapi_files[@]}"}"; do
    if [[ -f "${f}" ]] && rg -q -F "x-generated-by: cursor-bootstrap --enrich-spec-center" "${f}"; then
      add_delete_path "${f}"
    fi
  done
fi

if [[ ${#DELETE_PATHS[@]} -eq 0 ]]; then
  echo "[cursor-cleanup] nothing to clean."
  exit 0
fi

echo "[cursor-cleanup] target: ${PROJECT_DIR}"
echo "[cursor-cleanup] mode: $( [[ "${APPLY}" == "1" ]] && echo apply || echo dry-run )"
echo "[cursor-cleanup] delete candidates:"
for p in "${DELETE_PATHS[@]}"; do
  echo "- ${p}"
done

if [[ "${APPLY}" != "1" ]]; then
  echo "[cursor-cleanup] dry-run only. Re-run with --apply to execute deletion."
  exit 0
fi

for p in "${DELETE_PATHS[@]}"; do
  if [[ -d "${p}" ]]; then
    rm -rf "${p}"
  elif [[ -f "${p}" ]]; then
    rm -f "${p}"
  fi
done

echo "[cursor-cleanup] done."
